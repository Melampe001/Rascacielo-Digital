name: Imperial Dependency Guardian

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Dependency Guardian - Scan
        id: scan
        run: |
          echo "ðŸ” Running Imperial Dependency Guardian Agent..."
          node agents/supreme/imperial-dependency-guardian-agent.js --scan > guardian-report.json || true
          
      - name: Display Scan Results
        run: |
          if [ -f guardian-report.json ]; then
            echo "ðŸ“Š Dependency Scan Results:"
            cat guardian-report.json
          fi

      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

      - name: Auto-update security patches
        if: github.event_name == 'schedule' && github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ”„ Applying security updates..."
          node agents/supreme/imperial-dependency-guardian-agent.js --update --security-only || true

      - name: Create PR for updates
        if: github.event_name == 'schedule' && github.ref == 'refs/heads/main'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore(deps): security updates from Imperial Dependency Guardian'
          title: 'ðŸ”’ Security Updates - Imperial Dependency Guardian'
          body: |
            ## ðŸ›ï¸ Imperial Dependency Guardian - Security Updates
            
            This PR contains automated security updates detected by the Imperial Dependency Guardian Agent.
            
            ### ðŸ“Š Scan Summary
            - Automated security patch updates
            - Tested before creating PR
            
            ### âœ… Verification
            - [ ] All tests passing
            - [ ] No breaking changes
            - [ ] Security vulnerabilities addressed
            
            **Generated by Imperial Dependency Guardian Agent v1.0.0**
          branch: guardian/security-updates
          labels: security, dependencies, automated

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dependency-scan-results
          path: |
            guardian-report.json
          retention-days: 30

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze Licenses
        run: |
          echo "ðŸ“œ Analyzing dependency licenses..."
          node agents/supreme/imperial-dependency-guardian-agent.js --licenses > licenses-report.json || true
          
      - name: Display License Results
        run: |
          if [ -f licenses-report.json ]; then
            echo "ðŸ“‹ License Analysis Results:"
            cat licenses-report.json
          fi

      - name: Upload license results
        uses: actions/upload-artifact@v3
        with:
          name: license-analysis
          path: licenses-report.json
          retention-days: 30
