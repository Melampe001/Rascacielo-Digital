name: Auto-merge Approved PRs

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  auto-merge:
    # Trigger on GitHub approval OR comment with approval keywords
    # Supported approval keywords (Spanish & English):
    #   - 'Aprobado' / 'aprobado' (Spanish)
    # This workflow supports multi-language approval for international teams
    if: |
      (github.event.review.state == 'approved' || 
       contains(github.event.comment.body, 'Aprobado') ||
       contains(github.event.comment.body, 'aprobado'))
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "PR_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto-merge PR
        run: npm run pr:merge ${{ steps.pr-number.outputs.PR_NUMBER }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notify success
        if: success()
        run: |
          echo "✅ PR #${{ steps.pr-number.outputs.PR_NUMBER }} merged successfully!"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Failed to auto-merge PR #${{ steps.pr-number.outputs.PR_NUMBER }}"
